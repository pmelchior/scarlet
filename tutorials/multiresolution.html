<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Multi-Resolution Tutorial &#8212; scarlet  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="canonical" href="api/tutorials/multiresolution.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Scarlet Lite Tutorial" href="lite.html" />
    <link rel="prev" title="Starlet Tutorial: Modeling a Low Surface Brightness Galaxy" href="wavelet_model.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.svg" alt="Logo"/>
            </a></p>
<h3><a href="../index.html">Table of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0-quickstart.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1-concepts.html">Core Concepts</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="display.html">Displaying Scenes</a></li>
<li class="toctree-l2"><a class="reference internal" href="point_source.html">Point Source Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="wavelet_model.html">Starlet Tutorial: Modeling a Low Surface Brightness Galaxy</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Multi-Resolution Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="lite.html">Scarlet Lite Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="multiscale_deblending.html">Multiscale deblending tutorial</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api/scarlet.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../regression.html">Regression Testing</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="Multi-Resolution-Tutorial">
<h1>Multi-Resolution Tutorial<a class="headerlink" href="#Multi-Resolution-Tutorial" title="Permalink to this heading">¶</a></h1>
<p>This tutorial shows how to model sources frome images observed with different telescopes. We will use a multiband observation with the Hyper-Sprime Cam (HSC) and a single high-resolution image from the Hubble Space Telescope (HST).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import Packages and setup</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scarlet</span>
<span class="kn">import</span> <span class="nn">astropy.io.fits</span> <span class="k">as</span> <span class="nn">fits</span>
<span class="kn">from</span> <span class="nn">astropy.wcs</span> <span class="kn">import</span> <span class="n">WCS</span>
<span class="kn">from</span> <span class="nn">scarlet.display</span> <span class="kn">import</span> <span class="n">AsinhMapping</span>

<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="c1"># use a better colormap and don&#39;t interpolate the pixels</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<section id="Load-Data">
<h2>Load Data<a class="headerlink" href="#Load-Data" title="Permalink to this heading">¶</a></h2>
<p>We first load the HSC and HST images, channel names, and PSFs. For the images, we need to swap the byte order if necessary because a bug in astropy does not respect the local endianness… We also don’t have precomputed weight/variance maps, so we will need to compute them afterwards.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the HSC image data</span>
<span class="n">obs_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;../../data/test_resampling/Cut_HSC1.fits&#39;</span><span class="p">)</span>
<span class="n">data_hsc</span> <span class="o">=</span> <span class="n">obs_hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span><span class="o">.</span><span class="n">newbyteorder</span><span class="p">()</span>
<span class="n">wcs_hsc</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">obs_hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
<span class="n">channels_hsc</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;i&#39;</span><span class="p">,</span><span class="s1">&#39;z&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>

<span class="c1"># Load the HSC PSF data</span>
<span class="n">psf_hsc</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;../../data/test_resampling/PSF_HSC.fits&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">Np1</span><span class="p">,</span> <span class="n">Np2</span> <span class="o">=</span> <span class="n">psf_hsc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
<span class="n">psf_hsc</span> <span class="o">=</span> <span class="n">scarlet</span><span class="o">.</span><span class="n">ImagePSF</span><span class="p">(</span><span class="n">psf_hsc</span><span class="p">)</span>

<span class="c1"># Load the HST image data</span>
<span class="n">hst_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;../../data/test_resampling/Cut_HST1.fits&#39;</span><span class="p">)</span>
<span class="n">data_hst</span> <span class="o">=</span> <span class="n">hst_hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">wcs_hst</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">hst_hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
<span class="n">channels_hst</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F814W&#39;</span><span class="p">]</span>

<span class="c1"># Load the HST PSF data</span>
<span class="n">psf_hst</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;../../data/test_resampling/PSF_HST.fits&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">psf_hst</span> <span class="o">=</span> <span class="n">psf_hst</span><span class="p">[</span><span class="kc">None</span><span class="p">,:,:]</span>
<span class="n">psf_hst</span> <span class="o">=</span> <span class="n">scarlet</span><span class="o">.</span><span class="n">ImagePSF</span><span class="p">(</span><span class="n">psf_hst</span><span class="p">)</span>

<span class="c1"># Scale the HST data</span>
<span class="n">n1</span><span class="p">,</span><span class="n">n2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">data_hst</span><span class="p">)</span>
<span class="n">data_hst</span> <span class="o">=</span> <span class="n">data_hst</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">)</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span><span class="o">.</span><span class="n">newbyteorder</span><span class="p">()</span>
<span class="n">data_hst</span> <span class="o">*=</span> <span class="n">data_hsc</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="n">data_hst</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="n">r</span><span class="p">,</span> <span class="n">N1</span><span class="p">,</span> <span class="n">N2</span> <span class="o">=</span> <span class="n">data_hsc</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
</section>
<section id="Create-Frame-and-Observations">
<h2>Create Frame and Observations<a class="headerlink" href="#Create-Frame-and-Observations" title="Permalink to this heading">¶</a></h2>
<p>Unlike the single resolution examples, we now have two different instruments with different pixel resolutions, so we need two different observations. Since the HST image is at a much higher resolution, we define our model <code class="docutils literal notranslate"><span class="pre">Frame</span></code> to use the HST PSF and the HST resolution. Because there is no resampling between the model frame and the HST observation, we can use the default <code class="docutils literal notranslate"><span class="pre">Observation</span></code> class for the HST data. The HSC images have lower resolution, so we need to resample the models to this
frame, and that’s done by <code class="docutils literal notranslate"><span class="pre">LowResObservation</span></code>.</p>
<p>Users can specify <code class="docutils literal notranslate"><span class="pre">Frame</span></code>, <code class="docutils literal notranslate"><span class="pre">Observation</span></code> and <code class="docutils literal notranslate"><span class="pre">LowResObservation</span></code> instances by hand and match them as is usually done in single observation fitting. Alternatively, the user can provide a list of observation (no matter what the resolution of each observation is), from which the <code class="docutils literal notranslate"><span class="pre">from_observations</span></code> method will decide how large the model frame has to be and which observation(s) should be a <code class="docutils literal notranslate"><span class="pre">LowResObservation</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># define two observation packages and match to frame</span>
<span class="n">obs_hst</span> <span class="o">=</span> <span class="n">scarlet</span><span class="o">.</span><span class="n">Observation</span><span class="p">(</span><span class="n">data_hst</span><span class="p">,</span>
                              <span class="n">wcs</span><span class="o">=</span><span class="n">wcs_hst</span><span class="p">,</span>
                              <span class="n">psf</span><span class="o">=</span><span class="n">psf_hst</span><span class="p">,</span>
                              <span class="n">channels</span><span class="o">=</span><span class="n">channels_hst</span><span class="p">,</span>
                              <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="n">obs_hsc</span> <span class="o">=</span> <span class="n">scarlet</span><span class="o">.</span><span class="n">Observation</span><span class="p">(</span><span class="n">data_hsc</span><span class="p">,</span>
                              <span class="n">wcs</span><span class="o">=</span><span class="n">wcs_hsc</span><span class="p">,</span>
                              <span class="n">psf</span><span class="o">=</span><span class="n">psf_hsc</span><span class="p">,</span>
                              <span class="n">channels</span><span class="o">=</span><span class="n">channels_hsc</span><span class="p">,</span>
                              <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="n">observations</span> <span class="o">=</span> <span class="p">[</span><span class="n">obs_hsc</span><span class="p">,</span> <span class="n">obs_hst</span><span class="p">]</span>
<span class="n">model_psf</span> <span class="o">=</span> <span class="n">scarlet</span><span class="o">.</span><span class="n">GaussianPSF</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">model_frame</span> <span class="o">=</span> <span class="n">scarlet</span><span class="o">.</span><span class="n">Frame</span><span class="o">.</span><span class="n">from_observations</span><span class="p">(</span><span class="n">observations</span><span class="p">,</span> <span class="n">coverage</span><span class="o">=</span><span class="s1">&#39;intersection&#39;</span><span class="p">,</span> <span class="n">model_psf</span><span class="o">=</span><span class="n">model_psf</span><span class="p">)</span>
<span class="n">obs_hsc</span><span class="p">,</span> <span class="n">obs_hst</span> <span class="o">=</span> <span class="n">observations</span>
</pre></div>
</div>
</div>
<p>Next we have to create a source catalog for the images. We’ll use <code class="docutils literal notranslate"><span class="pre">sep</span></code> for that, but any other detection method will do. Since HST is higher resolution and less affected by blending, we use it for detection but we also run detection on the HSC image to calculate the background RMS:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sep</span>

<span class="k">def</span> <span class="nf">makeCatalog</span><span class="p">(</span><span class="n">obs_lr</span><span class="p">,</span> <span class="n">obs_hr</span><span class="p">,</span> <span class="n">lvl</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">wave</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="c1"># Create a catalog of detected source by running SEP on the wavelet transform</span>
    <span class="c1"># of the sum of the high resolution images and the low resolution images interpolated to the high resolution grid</span>
    <span class="c1">#Interpolate LR to HR</span>
    <span class="n">interp</span> <span class="o">=</span> <span class="n">scarlet</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">interpolate_observation</span><span class="p">(</span><span class="n">obs_lr</span><span class="p">,</span> <span class="n">obs_hr</span><span class="p">)</span>
    <span class="c1"># Normalisation</span>
    <span class="n">interp</span> <span class="o">=</span> <span class="n">interp</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">interp</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))[:,</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">hr_images</span> <span class="o">=</span> <span class="n">obs_hr</span><span class="o">.</span><span class="n">data</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">obs_hr</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))[:,</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="c1"># Summation to create a detection image</span>
    <span class="n">detect_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">interp</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hr_images</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Rescaling to HR image flux</span>
    <span class="n">detect_image</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">obs_hr</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># Wavelet transform</span>
    <span class="n">wave_detect</span> <span class="o">=</span> <span class="n">scarlet</span><span class="o">.</span><span class="n">Starlet</span><span class="o">.</span><span class="n">from_image</span><span class="p">(</span><span class="n">detect_image</span><span class="p">)</span><span class="o">.</span><span class="n">coefficients</span>

    <span class="k">if</span> <span class="n">wave</span><span class="p">:</span>
        <span class="c1"># Creates detection from the first 3 wavelet levels</span>
        <span class="n">detect</span> <span class="o">=</span> <span class="n">wave_detect</span><span class="p">[:</span><span class="n">lvl</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">detect</span> <span class="o">=</span> <span class="n">detect_image</span>

        <span class="c1"># Runs SEP detection</span>
    <span class="n">bkg</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">Background</span><span class="p">(</span><span class="n">detect</span><span class="p">)</span>
    <span class="n">catalog</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">detect</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="n">bkg</span><span class="o">.</span><span class="n">globalrms</span><span class="p">)</span>
    <span class="n">bg_rms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="p">[</span><span class="n">obs_lr</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">obs_hr</span><span class="o">.</span><span class="n">data</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">bg_rms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sep</span><span class="o">.</span><span class="n">Background</span><span class="p">(</span><span class="n">band</span><span class="p">)</span><span class="o">.</span><span class="n">globalrms</span> <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">img</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bg_rms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sep</span><span class="o">.</span><span class="n">Background</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">globalrms</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">catalog</span><span class="p">,</span> <span class="n">bg_rms</span><span class="p">,</span> <span class="n">detect_image</span>

<span class="c1"># Making catalog.</span>
<span class="c1"># With the wavelet option on, only the first 3 wavelet levels are used for detection. Set to 1 for better detection</span>
<span class="n">wave</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">lvl</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">catalog_hst</span><span class="p">,</span> <span class="p">(</span><span class="n">bg_hsc</span><span class="p">,</span> <span class="n">bg_hst</span><span class="p">),</span> <span class="n">detect</span> <span class="o">=</span> <span class="n">makeCatalog</span><span class="p">(</span><span class="n">obs_hsc</span><span class="p">,</span> <span class="n">obs_hst</span><span class="p">,</span> <span class="n">lvl</span><span class="p">,</span> <span class="n">wave</span><span class="p">)</span>

<span class="c1"># we can now set the empirical noise rms for both observations</span>
<span class="n">obs_hsc</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">obs_hsc</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">bg_hsc</span><span class="o">**</span><span class="mi">2</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
<span class="n">obs_hst</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">obs_hst</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">bg_hst</span><span class="o">**</span><span class="mi">2</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>Finally we can visualize the detections for the multi-band HSC and single-band HST images in their native resolutions:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a color mapping for the HSC image</span>
<span class="n">norm_hsc</span> <span class="o">=</span> <span class="n">AsinhMapping</span><span class="p">(</span><span class="n">minimum</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">norm_hst</span> <span class="o">=</span> <span class="n">AsinhMapping</span><span class="p">(</span><span class="n">minimum</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">norms</span> <span class="o">=</span> <span class="p">[</span><span class="n">norm_hsc</span><span class="p">,</span> <span class="n">norm_hst</span><span class="p">]</span>

<span class="c1"># Get the source coordinates from the HST catalog</span>
<span class="n">pixel_hst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">catalog_hst</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">catalog_hst</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># Convert the HST coordinates to the HSC WCS</span>
<span class="n">ra_dec</span> <span class="o">=</span> <span class="n">obs_hst</span><span class="o">.</span><span class="n">get_sky_coord</span><span class="p">(</span><span class="n">pixel_hst</span><span class="p">)</span>

<span class="k">for</span> <span class="n">obs</span><span class="p">,</span> <span class="n">norm</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">observations</span><span class="p">,</span> <span class="n">norms</span><span class="p">):</span>
    <span class="n">scarlet</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">show_observation</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">sky_coords</span><span class="o">=</span><span class="n">ra_dec</span><span class="p">,</span> <span class="n">show_psf</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_9_0.png" src="../_images/tutorials_multiresolution_9_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_9_1.png" src="../_images/tutorials_multiresolution_9_1.png" />
</div>
</div>
</section>
<section id="Initialize-Sources-and-Blend">
<h2>Initialize Sources and Blend<a class="headerlink" href="#Initialize-Sources-and-Blend" title="Permalink to this heading">¶</a></h2>
<p>We expect all sources to be galaxies, so we initialized them as <code class="docutils literal notranslate"><span class="pre">ExtendedSources</span></code>. Afterwards, we match their amplitudes to the data, and create an instance of <code class="docutils literal notranslate"><span class="pre">Blend</span></code> to hold all sources and <em>all</em> observations for the fit below.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Source initialisation</span>
<span class="n">sources</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">scarlet</span><span class="o">.</span><span class="n">ExtendedSource</span><span class="p">(</span><span class="n">model_frame</span><span class="p">,</span>
                           <span class="n">sky_coord</span><span class="p">,</span>
                           <span class="n">observations</span><span class="p">,</span>
                           <span class="n">thresh</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                          <span class="p">)</span>
    <span class="k">for</span> <span class="n">sky_coord</span> <span class="ow">in</span> <span class="n">ra_dec</span>
<span class="p">]</span>
<span class="n">scarlet</span><span class="o">.</span><span class="n">initialization</span><span class="o">.</span><span class="n">set_spectra_to_match</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">observations</span><span class="p">)</span>
<span class="n">blend</span> <span class="o">=</span> <span class="n">scarlet</span><span class="o">.</span><span class="n">Blend</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">observations</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Display-Initial-guess">
<h2>Display Initial guess<a class="headerlink" href="#Display-Initial-guess" title="Permalink to this heading">¶</a></h2>
<p>Let’s compare the initial guess in both observation frames. Note that the full model comprises more spectral channels and/or pixels than any individual observation. That’s a result of defining</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">observations</span><span class="p">)):</span>
    <span class="n">scarlet</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">show_scene</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span>
                               <span class="n">norm</span><span class="o">=</span><span class="n">norms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                               <span class="n">observation</span><span class="o">=</span><span class="n">observations</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                               <span class="n">show_model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">show_rendered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">show_observed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">show_residual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
                              <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_13_0.png" src="../_images/tutorials_multiresolution_13_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_13_1.png" src="../_images/tutorials_multiresolution_13_1.png" />
</div>
</div>
</section>
<section id="Fit-Model">
<h2>Fit Model<a class="headerlink" href="#Fit-Model" title="Permalink to this heading">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">time</span> it, logL = blend.fit(50, e_rel=1e-4)
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;scarlet ran for </span><span class="si">{</span><span class="n">it</span><span class="si">}</span><span class="s2"> iterations to logL = </span><span class="si">{</span><span class="n">logL</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">scarlet</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">show_likelihood</span><span class="p">(</span><span class="n">blend</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 3min, sys: 17.2 s, total: 3min 17s
Wall time: 2min 18s
scarlet ran for 50 iterations to logL = 11599.932592849178
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_15_1.png" src="../_images/tutorials_multiresolution_15_1.png" />
</div>
</div>
<section id="View-Updated-Model">
<h3>View Updated Model<a class="headerlink" href="#View-Updated-Model" title="Permalink to this heading">¶</a></h3>
<p>We use the same principle to look at the updated model:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">observations</span><span class="p">)):</span>
    <span class="n">scarlet</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">show_scene</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span>
                               <span class="n">norm</span><span class="o">=</span><span class="n">norms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                               <span class="n">observation</span><span class="o">=</span><span class="n">observations</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                               <span class="n">show_model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">show_rendered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">show_observed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">show_residual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
                              <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_17_0.png" src="../_images/tutorials_multiresolution_17_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_17_1.png" src="../_images/tutorials_multiresolution_17_1.png" />
</div>
</div>
</section>
<section id="View-Source-Models">
<h3>View Source Models<a class="headerlink" href="#View-Source-Models" title="Permalink to this heading">¶</a></h3>
<p>It can also be useful to view the model for each source. For each source we extract the portion of the image contained in the sources bounding box, the true simulated source flux, and the model of the source, scaled so that all of the images have roughly the same pixel scale.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;source number &#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">observations</span><span class="p">)):</span>
        <span class="n">scarlet</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">show_sources</span><span class="p">((</span><span class="n">sources</span><span class="p">[</span><span class="n">k</span><span class="p">],),</span>
                                     <span class="n">norm</span><span class="o">=</span><span class="n">norm_hst</span><span class="p">,</span>
                                     <span class="n">observation</span><span class="o">=</span><span class="n">observations</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                     <span class="n">show_model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">show_rendered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">show_observed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">show_spectrum</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">add_boxes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
                                    <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
source number  0
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_19_1.png" src="../_images/tutorials_multiresolution_19_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_19_2.png" src="../_images/tutorials_multiresolution_19_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
source number  1
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_19_4.png" src="../_images/tutorials_multiresolution_19_4.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_19_5.png" src="../_images/tutorials_multiresolution_19_5.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
source number  2
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_19_7.png" src="../_images/tutorials_multiresolution_19_7.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_19_8.png" src="../_images/tutorials_multiresolution_19_8.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
source number  3
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_19_10.png" src="../_images/tutorials_multiresolution_19_10.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_19_11.png" src="../_images/tutorials_multiresolution_19_11.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
source number  4
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_19_13.png" src="../_images/tutorials_multiresolution_19_13.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_19_14.png" src="../_images/tutorials_multiresolution_19_14.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
source number  5
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_19_16.png" src="../_images/tutorials_multiresolution_19_16.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_19_17.png" src="../_images/tutorials_multiresolution_19_17.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
source number  6
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_19_19.png" src="../_images/tutorials_multiresolution_19_19.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_19_20.png" src="../_images/tutorials_multiresolution_19_20.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
source number  7
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_19_22.png" src="../_images/tutorials_multiresolution_19_22.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_19_23.png" src="../_images/tutorials_multiresolution_19_23.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
source number  8
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_19_25.png" src="../_images/tutorials_multiresolution_19_25.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_19_26.png" src="../_images/tutorials_multiresolution_19_26.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
source number  9
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_19_28.png" src="../_images/tutorials_multiresolution_19_28.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_19_29.png" src="../_images/tutorials_multiresolution_19_29.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
source number  10
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_19_31.png" src="../_images/tutorials_multiresolution_19_31.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_multiresolution_19_32.png" src="../_images/tutorials_multiresolution_19_32.png" />
</div>
</div>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2018-2024, Fred Moolekamp and Peter Melchior.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../_sources/tutorials/multiresolution.ipynb"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>